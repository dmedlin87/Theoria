> **Archived on 2025-10-26**

# Lighthouse CI Workflow Fix - October 16, 2025

**Status:** ✅ Resolved  
**Issue:** 100% failure rate on Lighthouse CI workflow

## Root Causes Identified

### 1. **Invalid JSON in Environment Variable**
The `LHCI_COLLECT__URL` was using YAML multi-line syntax (`|`) which created an invalid JSON string:
```yaml
LHCI_COLLECT__URL: |
  [
    "http://...",
    ...
  ]
```
This produced a string with newlines instead of valid JSON array.

### 2. **Hardcoded URLs in Config**
`lighthouserc.json` had hardcoded localhost URLs that **overrode** the `LHCI_COLLECT__URL` environment variable, breaking dynamic target selection (localhost vs staging).

### 3. **Missing Baseline Manifest**
`.lighthouseci/baseline/manifest.json` didn't exist, causing the comparison script to fail every time.

### 4. **Manifest Path Mismatch**
The comparison script expected manifest at `.lighthouseci/current/manifest.json` but LHCI writes to `.lighthouseci/manifest.json`.

### 5. **LHCI Version Mismatch**
Workflow used `@lhci/cli@0.14.0` but `package.json` specified `0.15.1`.

### 6. **Directory Creation Race**
Server startup redirected logs to `.lighthouseci/server.log` before the directory was guaranteed to exist.

---

## Changes Applied

### ✅ Workflow Fixes (`.github/workflows/lighthouse.yml`)

**1. Fixed JSON formatting (line 149):**
```yaml
# Before (invalid multi-line)
LHCI_COLLECT__URL: |
  [
    "${{ steps.select.outputs.app_origin }}",
    ...
  ]

# After (valid single-line JSON)
LHCI_COLLECT__URL: '["${{ steps.select.outputs.app_origin }}","${{ steps.select.outputs.app_origin }}/verse/John.3.16","${{ steps.select.outputs.app_origin }}/search"]'
```

**2. Updated LHCI version (line 151):**
```yaml
# Before
npx --yes @lhci/cli@0.14.0 autorun

# After
npx --yes @lhci/cli@0.15.1 autorun
```

**3. Fixed manifest path (line 176):**
```bash
# Before
.lighthouseci/current/manifest.json

# After
.lighthouseci/manifest.json
```

**4. Added safety checks (lines 159-171):**
- Verify manifest.json was generated by LHCI
- Gracefully skip comparison if baseline missing
- Provide helpful error messages

**5. Added server PID logging (line 100):**
```bash
echo "Server PID: $!" >> .lighthouseci/server.log
```

### ✅ Config Fixes (`lighthouserc.json`)

**Removed hardcoded URLs:**
```json
// Before
"collect": {
  "url": [
    "http://127.0.0.1:3000",
    "http://127.0.0.1:3000/verse/John.3.16",
    "http://127.0.0.1:3000/search"
  ],
  "numberOfRuns": 1,
  ...
}

// After
"collect": {
  "numberOfRuns": 1,
  ...
}
```

Now the workflow's `LHCI_COLLECT__URL` env var controls the target URLs dynamically.

### ✅ Baseline Created

Created `.lighthouseci/baseline/manifest.json` with placeholder scores (90% performance, 95% accessibility/best-practices/seo).

**Important:** Run this to generate real baseline from your actual app:
```bash
cd theo/services/web
npm run build && npm run start

# In another terminal
node scripts/lighthouse-init-baseline.mjs
```

---

## How It Works Now

1. **Workflow sets target** → `LHCI_COLLECT__URL` env var with 3 URLs
2. **Config respects env var** → No hardcoded URLs to override
3. **LHCI runs audits** → Generates `.lighthouseci/manifest.json`
4. **Safety checks** → Verifies manifest exists before comparison
5. **Comparison runs** → Compares against baseline (if exists)
6. **Graceful degradation** → Skips comparison if baseline missing (doesn't fail)

---

## Testing the Fix

### Local Test
```bash
cd theo/services/web
npm run build
npm run start

# In another terminal
LHCI_COLLECT__URL='["http://127.0.0.1:3000","http://127.0.0.1:3000/verse/John.3.16","http://127.0.0.1:3000/search"]' \
npx @lhci/cli autorun --config ../../../lighthouserc.json
```

### CI Test
Push a commit or manually trigger the workflow:
```bash
gh workflow run lighthouse.yml --ref main
```

---

## Next Steps

1. **Generate real baseline:**
   ```bash
   node scripts/lighthouse-init-baseline.mjs
   ```
   Commit the resulting `manifest.json`.

2. **Monitor first few runs** to ensure stability

3. **Adjust thresholds** in `lighthouserc.json` if needed (currently set for CI environment)

---

## References

- **Workflow:** `.github/workflows/lighthouse.yml`
- **Config:** `lighthouserc.json`
- **Baseline:** `.lighthouseci/baseline/manifest.json`
- **Init Script:** `scripts/lighthouse-init-baseline.mjs`
- **Comparison Script:** `scripts/compare-lighthouse-baseline.mjs`
- **Previous Fix:** `docs/LIGHTHOUSE_FIX.md` (2025-01-14)
