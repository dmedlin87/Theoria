{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://theo.engine/schemas/case-builder.json",
  "title": "Case Builder Record",
  "description": "Schema describing the contract between Case Builder pipelines and Theo Engine persistence.",
  "type": "object",
  "additionalProperties": false,
  "required": ["source", "objects", "edges", "insights", "user_actions"],
  "properties": {
    "source": {"$ref": "#/$defs/CaseSource"},
    "objects": {
      "type": "array",
      "description": "Evidence objects produced from the source.",
      "items": {"$ref": "#/$defs/CaseObject"}
    },
    "edges": {
      "type": "array",
      "description": "Graph relationships linking case objects.",
      "items": {"$ref": "#/$defs/CaseEdge"}
    },
    "insights": {
      "type": "array",
      "description": "Insights generated from the evaluated graph.",
      "items": {"$ref": "#/$defs/CaseInsight"}
    },
    "user_actions": {
      "type": "array",
      "description": "Recorded analyst feedback tied to insights.",
      "items": {"$ref": "#/$defs/CaseUserAction"}
    }
  },
  "$defs": {
    "UUID": {
      "type": "string",
      "format": "uuid"
    },
    "ISODateTime": {
      "type": "string",
      "format": "date-time"
    },
    "CaseSource": {
      "type": "object",
      "title": "CaseSource",
      "description": "Source metadata powering case-builder evidence objects.",
      "additionalProperties": false,
      "required": ["id", "created_at", "updated_at"],
      "properties": {
        "id": {"$ref": "#/$defs/UUID"},
        "document_id": {
          "anyOf": [
            {"$ref": "#/$defs/UUID"},
            {"type": "null"}
          ],
          "description": "Foreign key to the originating Document."
        },
        "origin": {
          "type": ["string", "null"],
          "description": "Free-form origin label (e.g., archive name)."
        },
        "author": {
          "type": ["string", "null"],
          "description": "Primary author or speaker metadata."
        },
        "year": {
          "type": ["integer", "null"],
          "description": "Publication year where available."
        },
        "url": {
          "type": ["string", "null"],
          "format": "uri",
          "description": "Canonical URL to the source artifact."
        },
        "modality": {
          "type": ["string", "null"],
          "description": "Modality label such as text, audio, or video."
        },
        "meta": {
          "description": "Arbitrary ingestion metadata captured as JSON.",
          "anyOf": [
            {"type": "object"},
            {"type": "array"},
            {"type": "null"}
          ]
        },
        "created_at": {"$ref": "#/$defs/ISODateTime"},
        "updated_at": {"$ref": "#/$defs/ISODateTime"}
      }
    },
    "CaseObject": {
      "type": "object",
      "title": "CaseObject",
      "description": "Evidence object evaluated by the Case Builder pipeline.",
      "additionalProperties": false,
      "required": ["id", "object_type", "created_at", "updated_at"],
      "properties": {
        "id": {"$ref": "#/$defs/UUID"},
        "source_id": {
          "anyOf": [
            {"$ref": "#/$defs/UUID"},
            {"type": "null"}
          ],
          "description": "Owning CaseSource identifier."
        },
        "document_id": {
          "anyOf": [
            {"$ref": "#/$defs/UUID"},
            {"type": "null"}
          ],
          "description": "Linked Document identifier when present."
        },
        "passage_id": {
          "anyOf": [
            {"$ref": "#/$defs/UUID"},
            {"type": "null"}
          ],
          "description": "Related Passage identifier for scripture evidence."
        },
        "annotation_id": {
          "anyOf": [
            {"$ref": "#/$defs/UUID"},
            {"type": "null"}
          ],
          "description": "Related DocumentAnnotation identifier when applicable."
        },
        "object_type": {
          "type": "string",
          "enum": ["passage", "note", "claim", "evidence", "annotation"],
          "description": "Type discriminator describing the object role."
        },
        "title": {
          "type": ["string", "null"],
          "description": "Short title or heading for the object."
        },
        "body": {
          "type": ["string", "null"],
          "description": "Full body text or transcript snippet."
        },
        "osis_ranges": {
          "anyOf": [
            {
              "type": "array",
              "items": {"type": "string"},
              "description": "List of OSIS verse ranges covered by the object."
            },
            {"type": "null"}
          ]
        },
        "modality": {
          "type": ["string", "null"],
          "description": "Rendering modality for the object (e.g., text, video)."
        },
        "tags": {
          "anyOf": [
            {
              "type": "array",
              "items": {"type": "string"},
              "description": "Arbitrary tag labels."
            },
            {"type": "null"}
          ]
        },
        "embedding": {
          "anyOf": [
            {
              "type": "array",
              "items": {"type": "number"},
              "description": "Vector embedding produced for similarity search."
            },
            {"type": "null"}
          ]
        },
        "stability": {
          "type": ["number", "null"],
          "description": "Confidence metric for the object staying power."
        },
        "meta": {
          "description": "Free-form JSON payload for pipeline metadata.",
          "anyOf": [
            {"type": "object"},
            {"type": "array"},
            {"type": "null"}
          ]
        },
        "published_at": {
          "anyOf": [
            {"$ref": "#/$defs/ISODateTime"},
            {"type": "null"}
          ],
          "description": "Original publication timestamp if available."
        },
        "created_at": {"$ref": "#/$defs/ISODateTime"},
        "updated_at": {"$ref": "#/$defs/ISODateTime"}
      }
    },
    "CaseEdge": {
      "type": "object",
      "title": "CaseEdge",
      "description": "Relationship captured between Case Builder objects.",
      "additionalProperties": false,
      "required": ["id", "src_object_id", "dst_object_id", "kind", "created_at", "updated_at"],
      "properties": {
        "id": {"$ref": "#/$defs/UUID"},
        "src_object_id": {"$ref": "#/$defs/UUID"},
        "dst_object_id": {"$ref": "#/$defs/UUID"},
        "kind": {
          "type": "string",
          "enum": [
            "semantic_sim",
            "co_citation",
            "verse_overlap",
            "topic_overlap",
            "contradiction"
          ],
          "description": "Edge type describing why the connection exists."
        },
        "weight": {
          "type": ["number", "null"],
          "description": "Optional weight used during scoring."
        },
        "features": {
          "anyOf": [
            {"type": "object"},
            {"type": "null"}
          ],
          "description": "Computed feature payloads stored alongside the edge."
        },
        "created_at": {"$ref": "#/$defs/ISODateTime"},
        "updated_at": {"$ref": "#/$defs/ISODateTime"}
      }
    },
    "CaseInsight": {
      "type": "object",
      "title": "CaseInsight",
      "description": "Insight emitted by the Case Builder pipeline.",
      "additionalProperties": false,
      "required": ["id", "insight_type", "created_at", "updated_at"],
      "properties": {
        "id": {"$ref": "#/$defs/UUID"},
        "primary_object_id": {
          "anyOf": [
            {"$ref": "#/$defs/UUID"},
            {"type": "null"}
          ],
          "description": "Primary CaseObject anchor for the insight."
        },
        "insight_type": {
          "type": "string",
          "enum": ["convergence", "collision", "lead", "bundle"],
          "description": "Categorization of the surfaced insight."
        },
        "score": {
          "type": ["number", "null"],
          "description": "Primary scoring output for ranking insights."
        },
        "cluster_id": {
          "type": ["string", "null"],
          "description": "Optional cluster identifier for grouping insights."
        },
        "payload": {
          "anyOf": [
            {"type": "object"},
            {"type": "null"}
          ],
          "description": "Explainability payload and supporting metadata."
        },
        "created_at": {"$ref": "#/$defs/ISODateTime"},
        "updated_at": {"$ref": "#/$defs/ISODateTime"}
      }
    },
    "CaseUserAction": {
      "type": "object",
      "title": "CaseUserAction",
      "description": "Analyst feedback captured for Case Builder insights.",
      "additionalProperties": false,
      "required": ["id", "insight_id", "action", "created_at", "updated_at"],
      "properties": {
        "id": {"$ref": "#/$defs/UUID"},
        "insight_id": {"$ref": "#/$defs/UUID"},
        "action": {
          "type": "string",
          "enum": ["accept", "snooze", "discard", "pin", "mute"],
          "description": "Analyst response applied to the insight."
        },
        "confidence": {
          "type": ["number", "null"],
          "description": "Optional analyst confidence score (0-1)."
        },
        "payload": {
          "anyOf": [
            {"type": "object"},
            {"type": "null"}
          ],
          "description": "Structured metadata captured alongside the action."
        },
        "created_at": {"$ref": "#/$defs/ISODateTime"},
        "updated_at": {"$ref": "#/$defs/ISODateTime"}
      }
    }
  }
}
