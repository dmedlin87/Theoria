# 2025-10-26 Pytest Run Report

## Overview
- Invocation: full pytest suite (command not captured in log)
- Duration: ~4011.4 s (â‰ˆ1 h 6 m)
- Outcome: 91 failed, 1480 passed, 74 skipped, 26 errors, 6 warnings

## Slowest Tests
| Test | Duration (s) |
| --- | --- |
| tests/ingest/test_event_emission.py::test_file_pipeline_emits_document_event | 327.09 |
| tests/ingest/test_pipeline.py::test_run_pipeline_creates_case_builder_objects | 326.08 |
| tests/api/test_sql_migrations.py::test_sqlite_startup_restores_missing_perspective_column | 155.76 |
| tests/workers/test_tasks.py::test_process_url_updates_job_status_and_document_id | 111.21 |
| tests/workers/test_tasks.py::test_process_url_ingests_fixture_url | 110.64 |
| tests/services/api/app/ingest/test_events.py::test_dispatch_neighborhood_event_logs_exceptions | 109.11 |
| tests/services/api/app/ingest/test_events.py::test_dispatch_neighborhood_event_calls_function_when_delay_missing | 109.05 |
| tests/services/api/app/ingest/test_events.py::test_dispatch_neighborhood_event_uses_delay | 109.02 |
| tests/ingest/test_pipeline.py::test_run_pipeline_for_file_inlines_snapshot_when_small | 108.98 |
| tests/ingest/test_pipeline.py::test_youtube_fetch_retries_with_error_policy | 108.92 |
| tests/ingest/test_pipeline.py::test_transcript_pipeline_retries_parser_failure | 108.90 |
| tests/ingest/test_pipeline.py::test_run_pipeline_for_file_rejects_javascript_source_url | 108.89 |
| tests/ingest/test_pipeline.py::test_run_pipeline_for_file_persists_chunks | 108.87 |
| tests/ingest/test_pipeline.py::test_run_pipeline_for_large_file_uses_snapshot_manifest | 108.83 |
| tests/ingest/test_pipeline.py::test_pipeline_sanitises_adversarial_html | 108.81 |

_Note:_ The ingest pipeline suite dominates the top 50 slow tests; all variants run in ~109 s, suggesting heavy fixture work or external dependencies that should be investigated for caching or faking opportunities.

## Failure Summary (91 total)
| Module / Suite | Count | Notes |
| --- | --- | --- |
| tests/services/api/app/core/test_shims.py | 17 | Shim facade functions missing or misconfigured imports |
| tests/services/api/app/test_main.py | 15 | App factory setup paths failing (mounts, auth, tracing, metrics, health) |
| tests/api/test_export_zotero_route.py | 6 | Zotero export API contract regressions across success and failure paths |
| tests/services/api/app/retriever/test_documents.py | 5 | Document retrieval endpoints returning unexpected payloads and errors |
| tests/api/ai/test_ai_error_handling.py | 4 | Guardrail error handling functions breaking fallback/refusal guarantees |
| tests/api/test_workflow_spans.py | 4 | Workflow span emission assertions failing |
| tests/api/test_ai_trails.py | 3 | Trail digests not persisting/updating as expected |
| tests/api/test_ai_watchlists.py | 3 | Watchlist endpoints returning stub payloads and filters |
| tests/api/test_bootstrap_app_factory.py | 2 | App factory lifespan & settings bootstrap regressions |
| tests/db/test_seeds.py | 2 | Seeder cleanup and migration preconditions failing |
| tests/api/retriever/test_hybrid_search.py | 2 | API layer choosing wrong search backend |
| tests/services/api/app/retriever/test_hybrid_search.py | 2 | Service layer backend selection mismatches |
| tests/api/test_export_search_route.py | 2 | Export search route not honoring limit/overfetch expectations |
| tests/workers/test_tasks.py | 2 | Worker pipeline retry/backoff behavior and metadata enrichment failures |
| tests/services/api/app/ingest/test_events.py | 2 | Neighborhood event dispatch behavior regressions |
| tests/api/test_case_builder_ingest.py | 1 | Case builder toggle not creating records |
| tests/api/core/test_secret_migration.py | 1 | Secret migration shim does not warn or re-export helper |
| tests/platform/test_event_bus.py | 1 | Event bus error handling/logging not resilient |
| tests/architecture/test_dto_boundaries.py | 1 | DTO boundary rule broken (direct ORM import) |
| tests/api/test_ai_router.py | 1 | Router restart handling regression |
| tests/api/core/test_settings.py | 1 | Settings shim facade contract change |
| tests/adapters/graph/test_neo4j_adapter.py | 1 | Neo4j adapter ignoring supplied auth |
| tests/api/core/test_runtime.py | 1 | Runtime shim not re-exporting allow_insecure_startup |
| tests/api/ai/test_rag_pipeline_integration.py | 1 | Guarded chat not recording feedback |
| tests/data/test_research_package.py | 1 | Encoding handling regression |
| tests/api/core/test_database.py | 1 | Database shim facade regression |
| tests/architecture/test_module_boundaries.py | 1 | API adapters leaking outside infra namespace |
| tests/redteam/test_ai_redteam.py | 2 | Redteam guardrail flow producing regressions (in addition to errors below) |
| tests/api/core/test_settings_store.py | 1 | Settings store shim mismatch |
| tests/api/core/test_version.py | 1 | Version shim not exporting git sha |
| tests/scripts/test_launcher_helpers.py | 1 | Launcher helper aggregation regression |
| tests/ingest/test_tei_pipeline.py | 1 | TEI ingest metadata missing |
| tests/api/test_router_registration.py | 1 | Router metadata registration regression |
| tests/adapters/test_biblical_ai_processor.py | 1 | Hebrew verse processor not handling invalid AI payload |

## Error Summary (26 total)
| Module / Suite | Count | Notes |
| --- | --- | --- |
| tests/redteam/test_ai_redteam.py | 18 | Guardrail refusal suites raising unexpected exceptions before assertions |
| tests/api/test_workflow_spans.py | 4 | Span emission tests erroring (likely shared fixture crash) |
| tests/api/ai/test_ai_error_handling.py | 4 | Guarded answer helper raising exceptions before reaching assertions |

## Observations & Next Steps
- Shim and app-factory regressions suggest recent refactors moved or renamed exports without updating compatibility shims. Audit recent `services.api.app.core` and `api.core` changes and restore pass-through behavior or adjust tests.
- Guardrail-related suites (redteam and AI error handling) consistently error/fail, pointing to initialization failures in guardrail configuration. Capture stack traces from those errors and validate test fixtures.
- Ingest pipeline and worker suites dominate runtime (100+ s each). Profile fixture setup (database seeding, external API calls, video downloads) and introduce caching or lighter-weight fakes to reduce the ~30 minute cost of the ingest group alone.
- Document retriever and Zotero export APIs are in systemic failure; run targeted subsets (`pytest tests/services/api/app/retriever tests/api/test_export_zotero_route.py`) once environment fixes applied to verify progress.
